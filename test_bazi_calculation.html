<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…«å­—è®¡ç®—æµ‹è¯• - ç²¾ç¡®ä¿®å¤ç‰ˆæœ¬</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        h1 {
            color: #5a9;
            text-align: center;
        }
        .result-box {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #404040;
        }
        .method-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .method-box {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #404040;
        }
        .method-box.old {
            border-color: #f55;
        }
        .method-box.new {
            border-color: #5a9;
        }
        .method-title {
            color: #5a9;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #404040;
        }
        .method-box.old .method-title {
            color: #f55;
        }
        .bazi-item {
            margin: 10px 0;
            padding: 10px;
            background: #2d2d2d;
            border-radius: 4px;
        }
        .label {
            color: #5a9;
            font-weight: bold;
        }
        .method-box.old .label {
            color: #f55;
        }
        .expected-result {
            margin-top: 20px;
            padding: 15px;
            background: #3d3d3d;
            border-radius: 8px;
            border: 2px solid #9a5;
        }
        .bazi-string {
            font-size: 20px;
            font-weight: bold;
            color: #5a9;
            margin: 10px 0;
        }
        .error-analysis {
            margin-top: 20px;
            padding: 15px;
            background: #3d3d3d;
            border-radius: 8px;
            border: 2px solid #f55;
        }
        .debug-info {
            margin-top: 10px;
            padding: 10px;
            background: #2d2d2d;
            border-radius: 4px;
            font-size: 12px;
            color: #888;
        }
    </style>
</head>
<body>
    <h1>ğŸ”® å…«å­—è®¡ç®—æµ‹è¯• - ç²¾ç¡®ä¿®å¤ç‰ˆæœ¬</h1>
    <div class="result-box">
        <h2 style="text-align: center;">æµ‹è¯•æ—¶é—´ï¼š1999å¹´4æœˆ13æ—¥22:00</h2>
        <div class="expected-result">
            <h3 style="color: #9a5; margin-top: 0;">æœŸæœ›ç»“æœï¼šå¾…éªŒè¯</h3>
        </div>
        <div id="result"></div>
    </div>

    <script>
        // ========== BaZi.js ==========
        const Gan = ["ç”²", "ä¹™", "ä¸™", "ä¸", "æˆŠ", "å·±", "åºš", "è¾›", "å£¬", "ç™¸"];
        const Zhi = ["å­", "ä¸‘", "å¯…", "å¯", "è¾°", "å·³", "åˆ", "æœª", "ç”³", "é…‰", "æˆŒ", "äº¥"];
        const lunarInfo = [
            0x04bd8, 0x04ae0, 0x0a570, 0x054d5, 0x0d260, 0x0d950, 0x16554, 0x056a0, 0x09ad0, 0x055d2,
            0x04ae0, 0x0a5b6, 0x0a4d0, 0x0d250, 0x1d255, 0x0b540, 0x0d6a0, 0x0ada2, 0x095b0, 0x14977,
            0x04970, 0x0a4b0, 0x0b4b5, 0x06a50, 0x06d40, 0x1ab54, 0x02b60, 0x09570, 0x052f2, 0x04970,
            0x06566, 0x0d4a0, 0x0ea50, 0x06e95, 0x05ad0, 0x02b60, 0x186e3, 0x092e0, 0x1c8d7, 0x0c950,
            0x0d4a0, 0x1d8a6, 0x0b550, 0x056a0, 0x1a5b4, 0x025d0, 0x092d0, 0x0d2b2, 0x0a950, 0x0b557,
            0x06ca0, 0x0b550, 0x15355, 0x04da0, 0x0a5d0, 0x14573, 0x052d0, 0x0a9a8, 0x0e950, 0x06aa0,
            0x0aea6, 0x0ab50, 0x04b60, 0x0aae4, 0x0a570, 0x05260, 0x0f263, 0x0d950, 0x05b57, 0x056a0,
            0x096d0, 0x04dd5, 0x04ad0, 0x0a4d0, 0x0d4d4, 0x0d250, 0x0d558, 0x0b540, 0x0b5a0, 0x195a6,
            0x095b0, 0x049b0, 0x0a974, 0x0a4b0, 0x0b27a, 0x06a50, 0x06d40, 0x0af46, 0x0ab60, 0x09570,
            0x04af5, 0x04970, 0x064b0, 0x074a3, 0x0ea50, 0x06b58, 0x055c0, 0x0ab60, 0x096d5, 0x092e0,
            0x0c960, 0x0d954, 0x0d4a0, 0x0da50, 0x07552, 0x056a0, 0x0abb7, 0x025d0, 0x092d0, 0x0cab5,
            0x0a950, 0x0b4a0, 0x0baa4, 0x0ad50, 0x055d9, 0x04ba0, 0x0a5b0, 0x15176, 0x052b0, 0x0a930,
            0x07954, 0x06aa0, 0x0ad50, 0x05b52, 0x04b60, 0x0a6e6, 0x0a4e0, 0x0d260, 0x0ea65, 0x0d530,
            0x05aa0, 0x076a3, 0x096d0, 0x04bd7, 0x04ad0, 0x0a4d0, 0x1d0b6, 0x0d250, 0x0d520, 0x0dd45,
            0x0b5a0, 0x056d0, 0x055b2, 0x049b0, 0x0a577, 0x0a4b0, 0x0aa50, 0x1b255, 0x06d20, 0x0ada0
        ];

        // ========== Lunar.js - èŠ‚æ°”ä¿¡æ¯ ==========
        class Lunar {
            static solarTermInfo = [
                0, 21208, 42467, 63836, 85337, 107014, 128867, 150921,
                173149, 195551, 218072, 240693, 263343, 285989, 308563, 331033,
                353350, 375494, 397447, 419210, 440795, 462224, 483532, 504758
            ];

            // è·å–èŠ‚æ°”çš„å®Œæ•´æ—¶é—´ï¼ˆDateå¯¹è±¡ï¼‰
            static getSolarTermTime(solarYear, index) {
                const baseDate = new Date(1900, 0, 6, 2, 5, 0);
                const time = baseDate.getTime() + 31556925974.7 * (solarYear - 1900) + Lunar.solarTermInfo[index] * 60000;
                return new Date(time);
            }

            // è·å–èŠ‚æ°”çš„æ—¥æœŸï¼ˆä»…ç”¨äºå…¼å®¹ï¼‰
            static getSolarTermDay(solarYear, index) {
                return Lunar.getSolarTermTime(solarYear, index).getDate();
            }
        }

        class BaZi {
            constructor(cal) {
                this.cal = cal;
                this.baseDate = new Date(1900, 0, 31);
                this.init();
            }

            init() {
                let offset = Math.floor((this.cal - this.baseDate) / 86400000);
                let dayCyl = offset + 40;
                let monCyl = 14;

                let iYear, daysOfYear = 0;
                for (iYear = 1900; iYear < 2050 && offset > 0; iYear++) {
                    daysOfYear = this.yearDays(iYear);
                    offset -= daysOfYear;
                    monCyl += 12;
                }
                if (offset < 0) {
                    offset += daysOfYear;
                    iYear--;
                    monCyl -= 12;
                }

                this.year = iYear;
                let yearCyl = iYear - 1864;
                let leapMonth = this.leapMonth(iYear);
                this.leap = false;

                let iMonth, daysOfMonth = 0;
                for (iMonth = 1; iMonth < 13 && offset > 0; iMonth++) {
                    if (leapMonth > 0 && iMonth == (leapMonth + 1) && !this.leap) {
                        --iMonth;
                        this.leap = true;
                        daysOfMonth = this.leapDays(this.year);
                    } else {
                        daysOfMonth = this.monthDays(this.year, iMonth);
                    }
                    offset -= daysOfMonth;
                    if (this.leap && iMonth == (leapMonth + 1)) {
                        this.leap = false;
                    }
                    if (!this.leap) {
                        monCyl++;
                    }
                }

                if (offset == 0 && leapMonth > 0 && iMonth == leapMonth + 1) {
                    if (this.leap) {
                        this.leap = false;
                    } else {
                        this.leap = true;
                        --iMonth;
                        --monCyl;
                    }
                }

                if (offset < 0) {
                    offset += daysOfMonth;
                    --iMonth;
                    --monCyl;
                }

                this.month = iMonth;
                this.day = offset + 1;
            }

            yearDays(year) {
                let sum = 348;
                for (let i = 0x8000; i > 0x8; i >>= 1) {
                    if ((lunarInfo[year - 1900] & i) !== 0) sum += 1;
                }
                return sum + this.leapDays(year);
            }

            leapDays(year) {
                if (this.leapMonth(year) !== 0) {
                    if ((lunarInfo[year - 1900] & 0x10000) !== 0) {
                        return 30;
                    } else {
                        return 29;
                    }
                } else {
                    return 0;
                }
            }

            leapMonth(year) {
                return lunarInfo[year - 1900] & 0xf;
            }

            monthDays(year, month) {
                if ((lunarInfo[year - 1900] & (0x10000 >> month)) === 0) {
                    return 29;
                } else {
                    return 30;
                }
            }

            // æ—§æ–¹æ³•ï¼šä½¿ç”¨å†œå†æœˆä»½ï¼ˆé”™è¯¯ï¼‰
            getYearGanZhi_OLD(hour) {
                let idx = (this.year - 1864) % 60;
                const y = BaZi.jiazhi[idx];

                idx = idx % 5;
                const idxm = (idx + 1) * 2 % 10;
                const m = Gan[(idxm + this.month - 1) % 10] + Zhi[(this.month + 2 - 1) % 12];

                const offset = (Math.floor((this.cal - this.baseDate) / 86400000) + 40) % 60;
                const d = BaZi.jiazhi[offset];

                const h = Gan[(offset % 5 * 2 + hour) % 10] + Zhi[hour % 12];
                return `${y},${m},${d},${h}`;
            }

            // æ–°æ–¹æ³•ï¼šä½¿ç”¨å…¬å†å’Œç²¾ç¡®çš„èŠ‚æ°”æ—¶é—´ï¼ˆæ­£ç¡®ï¼‰
            getYearGanZhi(hour) {
                const solarYear = this.cal.getFullYear();
                const solarMonth = this.cal.getMonth(); // 0-11
                const solarDay = this.cal.getDate();
                const solarHour = this.cal.getHours();
                const solarMinute = this.cal.getMinutes();
                
                // å¹´æŸ±ï¼šæ ¹æ®ç«‹æ˜¥ï¼ˆsolar term 2ï¼‰çš„ç²¾ç¡®æ—¶é—´åˆ¤æ–­
                const term2Time = Lunar.getSolarTermTime(solarYear, 2); // ç«‹æ˜¥æ—¶é—´
                console.log("DEBUG: ç«‹æ˜¥æ—¶é—´:", term2Time.toLocaleString('zh-CN'));
                console.log("DEBUG: å½“å‰æ—¶é—´:", this.cal.toLocaleString('zh-CN'));
                console.log("DEBUG: å½“å‰æ—¶é—´æ˜¯å¦æ—©äºç«‹æ˜¥:", this.cal < term2Time);
                
                let baziYear = solarYear;
                if (this.cal < term2Time) {
                    // å¦‚æœå½“å‰æ—¶é—´æ—©äºç«‹æ˜¥ï¼Œç”¨ä¸Šä¸€å¹´çš„å¹´æŸ±
                    baziYear = solarYear - 1;
                    console.log("DEBUG: ä½¿ç”¨ä¸Šä¸€å¹´çš„å¹´æŸ±ï¼Œå¹´ä»½:", baziYear);
                } else {
                    console.log("DEBUG: ä½¿ç”¨å½“å‰å¹´ä»½çš„å¹´æŸ±ï¼Œå¹´ä»½:", baziYear);
                }
                let idx = (baziYear - 1864) % 60;
                const y = BaZi.jiazhi[idx];
                console.log("DEBUG: å¹´æŸ±ç´¢å¼•:", idx, "å¹´æŸ±:", y);

                // æœˆæŸ±ï¼šæ ¹æ®èŠ‚æ°”åˆ¤æ–­
                // å…«å­—æœˆæ”¯å¯¹åº”å…³ç³»ï¼ˆä»¥èŠ‚æ°”ä¸ºç•Œï¼‰ï¼š
                // æ­£æœˆ(å¯…æœˆ): ç«‹æ˜¥(2) -> æƒŠè›°(4)ä¹‹å‰
                // äºŒæœˆ(å¯æœˆ): æƒŠè›°(4) -> æ¸…æ˜(6)ä¹‹å‰
                // ä¸‰æœˆ(è¾°æœˆ): æ¸…æ˜(6) -> ç«‹å¤(8)ä¹‹å‰
                // å››æœˆ(å·³æœˆ): ç«‹å¤(8) -> èŠ’ç§(10)ä¹‹å‰
                // äº”æœˆ(åˆæœˆ): èŠ’ç§(10) -> å°æš‘(12)ä¹‹å‰
                // å…­æœˆ(æœªæœˆ): å°æš‘(12) -> ç«‹ç§‹(14)ä¹‹å‰
                // ä¸ƒæœˆ(ç”³æœˆ): ç«‹ç§‹(14) -> ç™½éœ²(16)ä¹‹å‰
                // å…«æœˆ(é…‰æœˆ): ç™½éœ²(16) -> å¯’éœ²(18)ä¹‹å‰
                // ä¹æœˆ(æˆŒæœˆ): å¯’éœ²(18) -> ç«‹å†¬(20)ä¹‹å‰
                // åæœˆ(äº¥æœˆ): ç«‹å†¬(20) -> å¤§é›ª(22)ä¹‹å‰
                // åä¸€æœˆ(å­æœˆ): å¤§é›ª(22) -> å°å¯’(0)ä¹‹å‰ï¼ˆè·¨å¹´ï¼‰
                // åäºŒæœˆ(ä¸‘æœˆ): å°å¯’(0) -> ç«‹æ˜¥(2)ä¹‹å‰
                
                // ç¡®å®šå½“å‰æ—¶é—´åœ¨å“ªä¸ªèŠ‚æ°”åŒºé—´
                let monthZhiIndex = -1;
                
                // èŠ‚æ°”ç´¢å¼•åˆ°æœˆæ”¯çš„æ˜ å°„
                // èŠ‚æ°”ç´¢å¼•: 0(å°å¯’)->ä¸‘(1), 2(ç«‹æ˜¥)->å¯…(2), 4(æƒŠè›°)->å¯(3), 6(æ¸…æ˜)->è¾°(4), 
                // 8(ç«‹å¤)->å·³(5), 10(èŠ’ç§)->åˆ(6), 12(å°æš‘)->æœª(7), 14(ç«‹ç§‹)->ç”³(8), 
                // 16(ç™½éœ²)->é…‰(9), 18(å¯’éœ²)->æˆŒ(10), 20(ç«‹å†¬)->äº¥(11), 22(å¤§é›ª)->å­(0)
                const termToZhi = {
                    0: 1,   // å°å¯’ -> ä¸‘æœˆ
                    2: 2,   // ç«‹æ˜¥ -> å¯…æœˆ
                    4: 3,   // æƒŠè›° -> å¯æœˆ
                    6: 4,   // æ¸…æ˜ -> è¾°æœˆ
                    8: 5,   // ç«‹å¤ -> å·³æœˆ
                    10: 6,  // èŠ’ç§ -> åˆæœˆ
                    12: 7,  // å°æš‘ -> æœªæœˆ
                    14: 8,  // ç«‹ç§‹ -> ç”³æœˆ
                    16: 9,  // ç™½éœ² -> é…‰æœˆ
                    18: 10, // å¯’éœ² -> æˆŒæœˆ
                    20: 11, // ç«‹å†¬ -> äº¥æœˆ
                    22: 0   // å¤§é›ª -> å­æœˆ
                };
                
                // æ£€æŸ¥æ‰€æœ‰èŠ‚æ°”åŒºé—´
                const termKeys = [0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22];
                for (let i = 0; i < termKeys.length; i++) {
                    const currentTerm = termKeys[i];
                    const nextTerm = i < termKeys.length - 1 ? termKeys[i + 1] : 0; // æœ€åä¸€ä¸ªèŠ‚æ°”åæ˜¯å°å¯’ï¼ˆè·¨å¹´ï¼‰
                    
                    const termTime = Lunar.getSolarTermTime(solarYear, currentTerm);
                    let nextTermTime;
                    if (nextTerm === 0 && currentTerm !== 0) {
                        // è·¨å¹´æƒ…å†µï¼šå¤§é›ª(22)ä¹‹åæ˜¯å°å¯’(0)ï¼Œéœ€è¦ä¸‹ä¸€å¹´çš„å°å¯’
                        nextTermTime = Lunar.getSolarTermTime(solarYear + 1, 0);
                    } else {
                        nextTermTime = Lunar.getSolarTermTime(solarYear, nextTerm);
                    }
                    
                    if (this.cal >= termTime && this.cal < nextTermTime) {
                        monthZhiIndex = termToZhi[currentTerm];
                        console.log("DEBUG: æ‰¾åˆ°èŠ‚æ°”åŒºé—´ - èŠ‚æ°”ç´¢å¼•:", currentTerm, "æœˆæ”¯ç´¢å¼•:", monthZhiIndex, "æœˆæ”¯:", Zhi[monthZhiIndex]);
                        break;
                    }
                }
                
                // å¦‚æœè¿˜æ²¡æ‰¾åˆ°ï¼Œæ£€æŸ¥è·¨å¹´çš„æƒ…å†µï¼ˆå¤§é›ªåˆ°å°å¯’ä¹‹é—´ï¼‰
                if (monthZhiIndex === -1) {
                    const term22 = Lunar.getSolarTermTime(solarYear, 22); // å¤§é›ª
                    const nextYearTerm0 = Lunar.getSolarTermTime(solarYear + 1, 0); // ä¸‹ä¸€å¹´çš„å°å¯’
                    if (this.cal >= term22 && this.cal < nextYearTerm0) {
                        monthZhiIndex = 0; // å­æœˆ
                        console.log("DEBUG: è·¨å¹´æƒ…å†µ - å¤§é›ªåˆ°å°å¯’ä¹‹é—´ï¼Œå­æœˆ");
                    }
                }
                
                // å¦‚æœä»ç„¶æ²¡æ‰¾åˆ°ï¼Œä½¿ç”¨é»˜è®¤å€¼ï¼ˆä¸åº”è¯¥å‘ç”Ÿï¼‰
                if (monthZhiIndex === -1) {
                    console.error("DEBUG: æ— æ³•ç¡®å®šæœˆæ”¯ï¼Œä½¿ç”¨é»˜è®¤å€¼");
                    monthZhiIndex = 0;
                }
                
                console.log("DEBUG: æœ€ç»ˆç¡®å®šçš„æœˆæ”¯ç´¢å¼•:", monthZhiIndex, "æœˆæ”¯:", Zhi[monthZhiIndex]);
                
                // æœˆå¹²ï¼šæ ¹æ®å¹´å¹²æ¨ç®—ï¼ˆäº”è™éï¼‰
                // äº”è™éå£è¯€ï¼šç”²å·±ä¹‹å¹´ä¸™ä½œé¦–ï¼Œä¹™åºšä¹‹å¹´æˆŠä¸ºå¤´ï¼Œä¸™è¾›ä¹‹å¹´å¯»åºšèµ·ï¼Œä¸å£¬å£¬å¯…é¡ºæ°´æµï¼Œè‹¥é—®æˆŠç™¸ä½•å¤„èµ·ï¼Œç”²å¯…ä¹‹ä¸Šå¥½è¿½æ±‚
                // å³ï¼šå¹´å¹²ä¸ºç”²æˆ–å·±ï¼Œæ­£æœˆä»ä¸™å¼€å§‹ï¼›å¹´å¹²ä¸ºä¹™æˆ–åºšï¼Œæ­£æœˆä»æˆŠå¼€å§‹ï¼›ç­‰ç­‰
                idx = idx % 5; // å¹´å¹²åœ¨åå¤©å¹²ä¸­çš„ä½ç½®ï¼ˆ0-4ï¼‰
                const idxm = (idx + 1) * 2 % 10; // äº”è™éçš„èµ·å§‹å¤©å¹²ç´¢å¼•
                // äº”è™éæ˜¯ä»å¯…æœˆå¼€å§‹è®¡ç®—çš„ï¼Œæ‰€ä»¥éœ€è¦å°†æœˆæ”¯è½¬æ¢ä¸ºä»å¯…æœˆå¼€å§‹çš„ç´¢å¼•
                // æœˆæ”¯ç´¢å¼•ï¼šå­(0), ä¸‘(1), å¯…(2), å¯(3), è¾°(4), å·³(5), åˆ(6), æœª(7), ç”³(8), é…‰(9), æˆŒ(10), äº¥(11)
                // è½¬æ¢ä¸ºä»å¯…æœˆå¼€å§‹ï¼šå¯…(2)->0, å¯(3)->1, è¾°(4)->2, ..., å­(0)->10, ä¸‘(1)->11
                const monthIndexForGan = (monthZhiIndex + 10) % 12; // å°†æœˆæ”¯è½¬æ¢ä¸ºä»å¯…æœˆå¼€å§‹çš„ç´¢å¼•ï¼ˆå¯…=0, å¯=1, ...ï¼‰
                const monthGanIndex = (idxm + monthIndexForGan) % 10;
                const m = Gan[monthGanIndex] + Zhi[monthZhiIndex];
                
                console.log("DEBUG: æœˆæŸ±è®¡ç®— - å¹´å¹²ç´¢å¼•:", idx, "äº”è™éèµ·å§‹:", idxm, "æœˆæ”¯ç´¢å¼•:", monthZhiIndex, "æœˆæ”¯ç´¢å¼•(äº”è™é):", monthIndexForGan, "æœˆå¹²ç´¢å¼•:", monthGanIndex);
                console.log("DEBUG: æœˆæŸ±:", m);

                // æ—¥æŸ±ï¼šæ ¹æ®æ—¥æœŸè®¡ç®—
                const offset = (Math.floor((this.cal - this.baseDate) / 86400000) + 40) % 60;
                const d = BaZi.jiazhi[offset];
                console.log("DEBUG: æ—¥æŸ±åç§»:", offset, "æ—¥æŸ±:", d);

                // æ—¶æŸ±ï¼šæ ¹æ®æ—¥å¹²å’Œæ—¶è¾°è®¡ç®—ï¼ˆäº”é¼ éï¼‰
                const dayGanIndex = offset % 10;
                const hourGanIndex = (dayGanIndex % 5 * 2 + hour) % 10;
                const h = Gan[hourGanIndex] + Zhi[hour % 12];
                console.log("DEBUG: æ—¶æŸ±è®¡ç®— - æ—¥å¹²ç´¢å¼•:", dayGanIndex, "æ—¶å¹²ç´¢å¼•:", hourGanIndex, "æ—¶æ”¯ç´¢å¼•:", hour % 12, "æ—¶æŸ±:", h);
                
                const result = `${y},${m},${d},${h}`;
                console.log("DEBUG: å®Œæ•´å…«å­—ç»“æœ:", result);
                return result;
            }

            animalsYear() {
                const Animals = ["é¼ ", "ç‰›", "è™", "å…”", "é¾™", "è›‡", "é©¬", "ç¾Š", "çŒ´", "é¸¡", "ç‹—", "çŒª"];
                return Animals[(this.year - 4) % 12];
            }
        }

        BaZi.jiazhi = [
            "ç”²å­", "ä¹™ä¸‘", "ä¸™å¯…", "ä¸å¯", "æˆŠè¾°", "å·±å·³", "åºšåˆ", "è¾›æœª", "å£¬ç”³", "ç™¸é…‰",
            "ç”²æˆŒ", "ä¹™äº¥", "ä¸™å­", "ä¸ä¸‘", "æˆŠå¯…", "å·±å¯", "åºšè¾°", "è¾›å·³", "å£¬åˆ", "ç™¸æœª",
            "ç”²ç”³", "ä¹™é…‰", "ä¸™æˆŒ", "ä¸äº¥", "æˆŠå­", "å·±ä¸‘", "åºšå¯…", "è¾›å¯", "å£¬è¾°", "ç™¸å·³",
            "ç”²åˆ", "ä¹™æœª", "ä¸™ç”³", "ä¸é…‰", "æˆŠæˆŒ", "å·±äº¥", "åºšå­", "è¾›ä¸‘", "å£¬å¯…", "ç™¸å¯",
            "ç”²è¾°", "ä¹™å·³", "ä¸™åˆ", "ä¸æœª", "æˆŠç”³", "å·±é…‰", "åºšæˆŒ", "è¾›äº¥", "å£¬å­", "ç™¸ä¸‘",
            "ç”²å¯…", "ä¹™å¯", "ä¸™è¾°", "ä¸å·³", "æˆŠåˆ", "å·±æœª", "åºšç”³", "è¾›é…‰", "å£¬æˆŒ", "ç™¸äº¥"
        ];

        // ========== PaiPanFinal.js ==========
        class PaiPanFinal {
            constructor() {
            }

            getBazi(cal, isman, useOldMethod = false) {
                let lunar = new BaZi(cal);
                let result = Array(10).fill("");
                let time = Math.floor(cal.getHours() / 2);

                // è·å–ç”Ÿè‚–
                let GanZhi;
                if (useOldMethod) {
                    GanZhi = lunar.getYearGanZhi_OLD(time);
                } else {
                    GanZhi = lunar.getYearGanZhi(time);
                }
                console.log("ganzhi:", GanZhi);
                let tempchar = GanZhi.split(",");
                let ganziyear = tempchar[0]; // å¹´æŸ±
                let ganzimonth = tempchar[1]; // æœˆæŸ±
                let ganziday = tempchar[2]; // æ—¥æŸ±
                let ganzitime = tempchar[3]; // æ—¶æŸ±

                const chineseInput = lunar.animalsYear();
                const englishOutput = translateZodiac(chineseInput);
                result[0] = englishOutput;
                result[1] = ganziyear.charAt(0); // å¹´å¹²
                result[2] = ganziyear.charAt(1); // å¹´æ”¯
                result[3] = ganzimonth.charAt(0); // æœˆå¹²
                result[4] = ganzimonth.charAt(1); // æœˆæ”¯
                result[5] = ganziday.charAt(0); // æ—¥å¹²
                result[6] = ganziday.charAt(1); // æ—¥æ”¯
                result[7] = ganzitime.charAt(0); // æ—¶å¹²
                result[8] = ganzitime.charAt(1); // æ—¶æ”¯

                return result;
            }
        }

        function translateZodiac(chineseZodiac) {
            const zodiacMap = {
                "é¼ ": "Rat", "ç‰›": "Ox", "è™": "Tiger", "å…”": "Rabbit",
                "é¾™": "Dragon", "è›‡": "Snake", "é©¬": "Horse", "ç¾Š": "Goat",
                "çŒ´": "Monkey", "é¸¡": "Rooster", "ç‹—": "Dog", "çŒª": "Pig"
            };
            return zodiacMap[chineseZodiac] || "Unknown zodiac";
        }

        function adjustTime(inputDate) {
            const inputTime = new Date(inputDate);
            const currentDate = new Date(inputTime.getFullYear(), inputTime.getMonth(), inputTime.getDate());
            const cutoffTime = new Date(currentDate);
            cutoffTime.setHours(22, 59, 0, 0);

            if (inputTime > cutoffTime) {
                const nextDay = new Date(currentDate);
                nextDay.setDate(nextDay.getDate() + 1);
                nextDay.setHours(0, 30, 0, 0);
                return nextDay;
            }
            return inputTime;
        }

        function formatResult(result, methodName, className, debugInfo = '') {
            return `
                <div class="method-box ${className}">
                    <div class="method-title">${methodName}</div>
                    <div class="bazi-item">
                        <span class="label">å¹´æŸ±ï¼š</span>${result.yearGan}${result.yearZhi}
                    </div>
                    <div class="bazi-item">
                        <span class="label">æœˆæŸ±ï¼š</span>${result.monthGan}${result.monthZhi}
                    </div>
                    <div class="bazi-item">
                        <span class="label">æ—¥æŸ±ï¼š</span>${result.dayGan}${result.dayZhi}
                    </div>
                    <div class="bazi-item">
                        <span class="label">æ—¶æŸ±ï¼š</span>${result.hourGan}${result.hourZhi}
                    </div>
                    <div class="bazi-item" style="margin-top: 15px; padding: 15px; background: #3d3d3d;">
                        <span class="label">å®Œæ•´å…«å­—ï¼š</span><br>
                        <div class="bazi-string">${result.baziFormatted}</div>
                    </div>
                    ${debugInfo ? `<div class="debug-info">${debugInfo}</div>` : ''}
                </div>
            `;
        }

        function calculateBazi() {
            const testDate = new Date(1999, 3, 13, 22, 0, 0); // 1999å¹´4æœˆ13æ—¥22:00ï¼ˆæœˆä»½ä»0å¼€å§‹ï¼Œ3è¡¨ç¤º4æœˆï¼‰
            const adjustedDate = adjustTime(testDate);
            
            console.log("æµ‹è¯•æ—¥æœŸ:", testDate.toLocaleString('zh-CN'));
            console.log("è°ƒæ•´åæ—¥æœŸ:", adjustedDate.toLocaleString('zh-CN'));
            
            // è®¡ç®—ç«‹æ˜¥æ—¶é—´ç”¨äºè°ƒè¯•
            const term2Time = Lunar.getSolarTermTime(1999, 2);
            console.log("1999å¹´ç«‹æ˜¥æ—¶é—´:", term2Time.toLocaleString('zh-CN'));
            console.log("å½“å‰æ—¶é—´æ˜¯å¦æ—©äºç«‹æ˜¥:", adjustedDate < term2Time);
            
            const mypaipan = new PaiPanFinal();
            
            // æ—§æ–¹æ³•
            const resultOld = mypaipan.getBazi(adjustedDate, true, true);
            const resultOldFormatted = {
                yearGan: resultOld[1],
                yearZhi: resultOld[2],
                monthGan: resultOld[3],
                monthZhi: resultOld[4],
                dayGan: resultOld[5],
                dayZhi: resultOld[6],
                hourGan: resultOld[7],
                hourZhi: resultOld[8],
                baziFormatted: `${resultOld[1]}${resultOld[2]} ${resultOld[3]}${resultOld[4]} ${resultOld[5]}${resultOld[6]} ${resultOld[7]}${resultOld[8]}`
            };
            
            // æ–°æ–¹æ³•
            const resultNew = mypaipan.getBazi(adjustedDate, true, false);
            const resultNewFormatted = {
                yearGan: resultNew[1],
                yearZhi: resultNew[2],
                monthGan: resultNew[3],
                monthZhi: resultNew[4],
                dayGan: resultNew[5],
                dayZhi: resultNew[6],
                hourGan: resultNew[7],
                hourZhi: resultNew[8],
                baziFormatted: `${resultNew[1]}${resultNew[2]} ${resultNew[3]}${resultNew[4]} ${resultNew[5]}${resultNew[6]} ${resultNew[7]}${resultNew[8]}`
            };
            
            // ä½¿ç”¨ä¹‹å‰å·²ç»è®¡ç®—çš„ term2Time
            const debugInfo = `ç«‹æ˜¥æ—¶é—´: ${term2Time.toLocaleString('zh-CN')}<br>å½“å‰æ—¶é—´: ${adjustedDate.toLocaleString('zh-CN')}<br>æ˜¯å¦æ—©äºç«‹æ˜¥: ${adjustedDate < term2Time}`;
            
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `
                <div class="method-comparison">
                    ${formatResult(resultOldFormatted, 'æ—§æ–¹æ³•ï¼ˆä½¿ç”¨å†œå†æœˆä»½ï¼‰', 'old')}
                    ${formatResult(resultNewFormatted, 'æ–°æ–¹æ³•ï¼ˆä½¿ç”¨ç²¾ç¡®èŠ‚æ°”æ—¶é—´ï¼‰', 'new', debugInfo)}
                </div>
                <div class="error-analysis">
                    <h3 style="color: #5a9; margin-top: 0;">è®¡ç®—ç»“æœ</h3>
                    <div class="bazi-item">
                        <strong>æ—§æ–¹æ³•ç»“æœï¼š</strong> ${resultOldFormatted.baziFormatted}<br>
                        <strong>æ–°æ–¹æ³•ç»“æœï¼š</strong> ${resultNewFormatted.baziFormatted}<br>
                        <strong>è¯´æ˜ï¼š</strong> æ–°æ–¹æ³•ä½¿ç”¨èŠ‚æ°”è®¡ç®—æœˆæŸ±ï¼Œæ—§æ–¹æ³•ä½¿ç”¨å†œå†æœˆä»½è®¡ç®—æœˆæŸ±
                    </div>
                </div>
            `;
            
            console.log("æ—§æ–¹æ³•ç»“æœ:", resultOldFormatted.baziFormatted);
            console.log("æ–°æ–¹æ³•ç»“æœ:", resultNewFormatted.baziFormatted);
            console.log("æœŸæœ›ç»“æœ:", expected);
        }

        window.onload = function() {
            calculateBazi();
        };
    </script>
</body>
</html>
